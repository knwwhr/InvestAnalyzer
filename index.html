<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Volume Analyzer - AI 추천 종목</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
    }

    .stock-card {
      transition: all 0.3s ease;
    }

    .stock-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    .pulse-animation {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
      animation: slideIn 0.5s ease-out;
    }

    .grade-S { background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%); }
    .grade-A { background: linear-gradient(135deg, #00cc00 0%, #008800 100%); }
    .grade-B { background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%); }
    .grade-C { background: linear-gradient(135deg, #888888 0%, #666666 100%); }
    .grade-D { background: linear-gradient(135deg, #cccccc 0%, #999999 100%); }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // API URL 자동 감지 (로컬 vs Vercel)
    const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3001/api'
      : 'https://investar-xi.vercel.app/api';  // Vercel 배포 후 변경

    // 메인 앱
    function App() {
      const [recommendations, setRecommendations] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [selectedStock, setSelectedStock] = useState(null);
      const [selectedCategory, setSelectedCategory] = useState('all');
      const [lastUpdate, setLastUpdate] = useState(null);
      const [activeTab, setActiveTab] = useState('screening'); // screening, performance, or patterns
      const [screeningMetadata, setScreeningMetadata] = useState(null); // 스크리닝 메타데이터

      // 추천 종목 불러오기
      const fetchRecommendations = async (category = 'all') => {
        try {
          setLoading(true);
          setError(null);

          // limit 제거 - 전체 종목 표시
          const url = category === 'all'
            ? `${API_BASE_URL}/screening/recommend`
            : `${API_BASE_URL}/screening/${category}`;

          const response = await fetch(url);
          const result = await response.json();

          if (result.success) {
            setRecommendations(result.recommendations || []);
            setScreeningMetadata(result.metadata || null);
            setLastUpdate(new Date());
          } else {
            setError(result.error || '데이터 로드 실패');
          }
        } catch (err) {
          setError('서버와 연결할 수 없습니다: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      // 종목 상세 분석
      const fetchStockDetail = async (stockCode) => {
        try {
          const response = await fetch(`${API_BASE_URL}/stock/${stockCode}/advanced-analysis`);
          const result = await response.json();

          if (result.success) {
            setSelectedStock(result.analysis);
          }
        } catch (err) {
          console.error('상세 분석 실패:', err);
        }
      };

      // 카테고리 변경
      const handleCategoryChange = (category) => {
        setSelectedCategory(category);
        fetchRecommendations(category);
      };

      // 초기 로드
      useEffect(() => {
        fetchRecommendations();
      }, []);

      return (
        <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50">
          {/* 헤더 */}
          <header className="bg-white shadow-lg border-b-4 border-indigo-600">
            <div className="max-w-7xl mx-auto px-4 py-6">
              <div className="flex items-center justify-between">
                <div>
                  <h1 className="text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                    🤖 AI Stock Screener
                  </h1>
                  <p className="text-gray-600 mt-2">거래량 AI가 추천하는 오늘의 종목</p>
                </div>
                <button
                  onClick={() => activeTab === 'screening' ? fetchRecommendations(selectedCategory) : window.location.reload()}
                  disabled={loading}
                  className="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 font-semibold shadow-lg"
                >
                  {loading ? '분석중...' : '🔄 새로고침'}
                </button>
              </div>
              {/* 탭 메뉴 */}
              <div className="flex gap-4 mt-6 border-b border-gray-200">
                <button
                  onClick={() => setActiveTab('screening')}
                  className={`px-6 py-3 font-semibold transition-all ${
                    activeTab === 'screening'
                      ? 'text-indigo-600 border-b-4 border-indigo-600'
                      : 'text-gray-500 hover:text-gray-700'
                  }`}
                >
                  📊 종목 스크리닝
                </button>
                <button
                  onClick={() => setActiveTab('patterns')}
                  className={`px-6 py-3 font-semibold transition-all ${
                    activeTab === 'patterns'
                      ? 'text-indigo-600 border-b-4 border-indigo-600'
                      : 'text-gray-500 hover:text-gray-700'
                  }`}
                >
                  🧠 패턴 분석
                </button>
                <button
                  onClick={() => setActiveTab('performance')}
                  className={`px-6 py-3 font-semibold transition-all ${
                    activeTab === 'performance'
                      ? 'text-indigo-600 border-b-4 border-indigo-600'
                      : 'text-gray-500 hover:text-gray-700'
                  }`}
                >
                  📈 성과 검증
                </button>
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 py-8">
            {/* 에러 메시지 */}
            {error && (
              <div className="bg-red-100 border-l-4 border-red-500 text-red-700 px-4 py-3 rounded mb-4 shadow">
                <div className="flex justify-between">
                  <span>{error}</span>
                  <button onClick={() => setError(null)} className="font-bold">×</button>
                </div>
              </div>
            )}

            {/* 탭별 콘텐츠 */}
            {activeTab === 'patterns' ? (
              <PatternAnalysis apiBaseUrl={API_BASE_URL} />
            ) : activeTab === 'screening' ? (
              <>
                {/* 마지막 업데이트 시간 */}
                {lastUpdate && (
                  <div className="text-sm text-gray-600 mb-4 text-center">
                    마지막 업데이트: {lastUpdate.toLocaleString('ko-KR')}
                  </div>
                )}

                {/* 스크리닝 메타데이터 */}
                {screeningMetadata && recommendations.length > 0 && (
                  <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 rounded">
                    <div className="flex items-center justify-center gap-6 text-sm">
                      <div>
                        <span className="text-gray-600">분석:</span>
                        <span className="font-bold text-blue-900 ml-1">{screeningMetadata.totalAnalyzed}개</span>
                      </div>
                      <div className="text-gray-400">|</div>
                      <div>
                        <span className="text-gray-600">조건 충족:</span>
                        <span className="font-bold text-green-700 ml-1">{screeningMetadata.totalFound}개</span>
                      </div>
                      <div className="text-gray-400">|</div>
                      <div>
                        <span className="text-gray-600">표시:</span>
                        <span className="font-bold text-indigo-700 ml-1">{screeningMetadata.returned}개</span>
                      </div>
                      {screeningMetadata.poolSize && (
                        <>
                          <div className="text-gray-400">|</div>
                          <div>
                            <span className="text-gray-600">풀 크기:</span>
                            <span className="font-bold text-purple-700 ml-1">{screeningMetadata.poolSize}개</span>
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                )}

                {/* 카테고리 필터 */}
                <CategoryFilter
                  selected={selectedCategory}
                  onChange={handleCategoryChange}
                  loading={loading}
                />

                {/* 추천 종목 그리드 */}
                {loading && recommendations.length === 0 ? (
                  <LoadingScreen />
                ) : recommendations.length === 0 ? (
                  <EmptyState category={selectedCategory} />
                ) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                    {recommendations.map((stock, index) => (
                      <RecommendationCard
                        key={stock.stockCode}
                        stock={stock}
                        rank={index + 1}
                        onClick={() => fetchStockDetail(stock.stockCode)}
                      />
                    ))}
                  </div>
                )}

                {/* 종목 상세 모달 */}
                {selectedStock && (
                  <StockDetailModal
                    stock={selectedStock}
                    onClose={() => setSelectedStock(null)}
                  />
                )}
              </>
            ) : (
              <PerformanceVerification apiBaseUrl={API_BASE_URL} />
            )}
          </main>
        </div>
      );
    }

    // 카테고리 필터
    function CategoryFilter({ selected, onChange, loading }) {
      const categories = [
        {
          id: 'all',
          name: '🏆 종합 TOP 10',
          icon: '🏆',
          desc: '모든 지표를 종합하여 점수가 높은 상위 10개 종목'
        },
        {
          id: 'whale',
          name: '🐋 고래 감지',
          icon: '🐋',
          desc: '거래량 급증 + 가격 상승 = 큰손의 매수 신호 포착'
        },
        {
          id: 'accumulation',
          name: '🤫 조용한 매집',
          icon: '🤫',
          desc: '낮은 변동성 + 거래량 증가 = 물량 조용히 모으는 중'
        },
        {
          id: 'escape',
          name: '🚀 탈출 속도',
          icon: '🚀',
          desc: '저항선 돌파 + 폭발적 거래량 = 상승 탄력 발생'
        },
        {
          id: 'drain',
          name: '💧 유동성 고갈',
          icon: '💧',
          desc: '거래량 급감 + 변동성 하락 = 곧 큰 변동 가능성'
        },
        {
          id: 'volume-surge',
          name: '🔥 거래량 폭발',
          icon: '🔥',
          desc: '평균 대비 2.5배 이상 거래량 급증 종목'
        }
      ];

      return (
        <div className="bg-white rounded-xl shadow-lg p-4">
          <div className="flex flex-wrap gap-3 justify-center">
            {categories.map(cat => (
              <div key={cat.id} className="relative group">
                <button
                  onClick={() => onChange(cat.id)}
                  disabled={loading}
                  className={`px-6 py-3 rounded-lg font-semibold transition-all ${
                    selected === cat.id
                      ? 'bg-indigo-600 text-white shadow-lg scale-105'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  <span className="text-xl mr-2">{cat.icon}</span>
                  {cat.name}
                </button>
                {/* 툴팁 */}
                <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10 shadow-xl">
                  {cat.desc}
                  <div className="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                    <div className="border-4 border-transparent border-t-gray-900"></div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // 추천 종목 카드
    function RecommendationCard({ stock, rank, onClick }) {
      const gradeClass = `grade-${stock.recommendation.grade}`;
      const isPositive = stock.changeRate >= 0;

      // 거래량 비율 계산
      const volumeRatio = stock.volumeAnalysis.current.volumeMA20
        ? (stock.volume / stock.volumeAnalysis.current.volumeMA20).toFixed(1)
        : null;

      // 뱃지 데이터
      const badges = [];
      if (stock.rankBadges) {
        if (stock.rankBadges.volumeSurge) badges.push({ text: '거래량급증', color: 'bg-red-500' });
        if (stock.rankBadges.tradingValue) badges.push({ text: '거래대금', color: 'bg-orange-500' });
        if (stock.rankBadges.volume) badges.push({ text: '거래량', color: 'bg-yellow-500' });
      }

      // 패턴 뱃지 추가
      if (stock.patternMatch && stock.patternMatch.matched) {
        badges.push({
          text: `급등패턴 +${stock.patternMatch.bonusScore.toFixed(0)}점`,
          color: 'bg-purple-500'
        });
      }

      return (
        <div
          className="stock-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer slide-in"
          onClick={onClick}
        >
          {/* 등급 배지 */}
          <div className={`${gradeClass} px-4 py-3 flex justify-between items-center`}>
            <span className="text-white font-bold text-lg">#{rank}</span>
            <span className="text-white font-bold text-2xl">{stock.recommendation.grade}</span>
            <span className="text-white text-sm">점수: {stock.totalScore}</span>
          </div>

          {/* 종목 정보 */}
          <div className="p-5">
            <div className="flex justify-between items-start mb-4">
              <div className="flex-1">
                <h3 className="text-xl font-bold text-gray-900">{stock.stockName}</h3>
                <p className="text-sm text-gray-500">{stock.stockCode}</p>
                {/* 랭킹 뱃지 */}
                {badges.length > 0 && (
                  <div className="flex flex-wrap gap-1 mt-2">
                    {badges.map((badge, i) => (
                      <span key={i} className={`${badge.color} text-white text-xs px-2 py-1 rounded-full font-semibold`}>
                        🏆 {badge.text}
                      </span>
                    ))}
                  </div>
                )}
              </div>
              <div className="text-right">
                <p className="text-2xl font-bold text-gray-900">
                  {stock.currentPrice.toLocaleString()}
                </p>
                <p className={`text-sm font-semibold ${isPositive ? 'text-red-600' : 'text-blue-600'}`}>
                  {isPositive ? '▲' : '▼'} {Math.abs(stock.changeRate).toFixed(2)}%
                </p>
              </div>
            </div>

            {/* 추천 이유 */}
            <div className="bg-gray-50 rounded-lg p-3 mb-4">
              <p className="text-sm font-semibold text-indigo-600 mb-2">
                {stock.recommendation.text}
              </p>
              <div className="flex flex-wrap gap-1 mb-2">
                {stock.advancedAnalysis.signals.slice(0, 3).map((signal, i) => (
                  <span key={i} className="text-xs bg-white px-2 py-1 rounded-full border border-gray-200">
                    {signal}
                  </span>
                ))}
              </div>
              {/* 선정 기준 상세 */}
              <div className="text-xs text-gray-600 mt-2 space-y-1">
                {stock.advancedAnalysis.indicators.whale.length > 0 && (() => {
                  const latestWhale = stock.advancedAnalysis.indicators.whale[stock.advancedAnalysis.indicators.whale.length - 1];
                  const hasWarning = latestWhale.warning;
                  return (
                    <div className="relative group inline-block">
                      <span className={`cursor-help border-b border-dotted ${hasWarning ? 'border-orange-400 text-orange-600' : 'border-gray-400'}`}>
                        🐋 고래감지 (최근10일): {stock.advancedAnalysis.indicators.whale.length}건 | 강도 {latestWhale.intensity.toFixed(1)}{hasWarning ? ' ⚠️' : ''}
                      </span>
                      {/* 툴팁 - 왼쪽 정렬 */}
                      <div className="absolute left-0 top-full mt-1 w-72 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-xl">
                        <div className="font-bold mb-1">🐋 고래 감지 [최근 10일 분석]</div>
                        <div className="space-y-1">
                          <div className="text-yellow-300">✅ 패턴 감지됨</div>
                          {hasWarning && <div className="text-orange-300">{latestWhale.warning}</div>}
                          <div className="border-t border-gray-700 my-1"></div>
                          <div>📊 분석 기간: 최근 10일</div>
                          <div>📈 비교 대상: 이전 20일 평균 거래량</div>
                          <div className="border-t border-gray-700 my-1"></div>
                          <div className="font-bold text-green-300">📌 감지 조건:</div>
                          <div>• 거래량이 평균 대비 2.5배 이상</div>
                          <div>• 가격 변동률 3% 이상</div>
                          <div>• 감지 횟수: {stock.advancedAnalysis.indicators.whale.length}회</div>
                          <div className="border-t border-gray-700 my-1"></div>
                          <div className="font-bold text-cyan-300">🎯 마감 분석:</div>
                          <div>• 고가 대비 낙폭: -{latestWhale.highDecline}%</div>
                          {hasWarning && <div className="text-orange-300">  (30% 이상 윗꼬리 = 되돌림 주의)</div>}
                          <div className="border-t border-gray-700 my-1"></div>
                          <div className="font-bold text-blue-300">💡 의미:</div>
                          <div>기관/외국인 등 큰 손이 매수 중</div>
                          <div>{hasWarning ? '장중 급등 후 되돌림 - 신중 진입' : '단기 급등 가능성 높음'}</div>
                        </div>
                        {/* 화살표 - 왼쪽 */}
                        <div className="absolute top-full left-6 transform -mt-1">
                          <div className="border-4 border-transparent border-t-gray-900"></div>
                        </div>
                      </div>
                    </div>
                  );
                })()}
                {stock.advancedAnalysis.indicators.accumulation.detected && (
                  <div className="relative group inline-block">
                    <span className="cursor-help border-b border-dotted border-gray-400">
                      🤫 조용한매집 (20일): 후반10일 vs 전반10일 | 거래량 +{stock.advancedAnalysis.indicators.accumulation.volumeGrowth}% | 변동성 {stock.advancedAnalysis.indicators.accumulation.priceVolatility}%
                    </span>
                    {/* 툴팁 - 중앙 정렬 */}
                    <div className="absolute left-1/2 transform -translate-x-1/2 top-full mt-1 w-72 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-xl">
                      <div className="font-bold mb-1">🤫 조용한 매집 [20일 분석]</div>
                      <div className="space-y-1">
                        <div className="text-yellow-300">✅ 패턴 감지됨</div>
                        <div className="border-t border-gray-700 my-1"></div>
                        <div>📊 분석 기간: 최근 20일</div>
                        <div>📈 비교 방식: 전반 10일 vs 후반 10일</div>
                        <div className="border-t border-gray-700 my-1"></div>
                        <div className="font-bold text-green-300">📌 측정 지표:</div>
                        <div>• 거래량 증가: +{stock.advancedAnalysis.indicators.accumulation.volumeGrowth}%</div>
                        <div>  (후반 10일 평균 > 전반 10일 평균)</div>
                        <div>• 가격 변동성: {stock.advancedAnalysis.indicators.accumulation.priceVolatility}%</div>
                        <div>  (낮을수록 안정적)</div>
                        <div className="border-t border-gray-700 my-1"></div>
                        <div className="font-bold text-blue-300">💡 의미:</div>
                        <div>세력이 가격 자극 없이 물량 모으는 중</div>
                        <div>1~2주 후 급등 가능성</div>
                      </div>
                      {/* 화살표 - 중앙 */}
                      <div className="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                        <div className="border-4 border-transparent border-t-gray-900"></div>
                      </div>
                    </div>
                  </div>
                )}
                {stock.advancedAnalysis.indicators.escape.detected && (
                  <div className="relative group inline-block">
                    <span className="cursor-help border-b border-dotted border-gray-400">
                      🚀 탈출속도 (30일): 저항선 {stock.advancedAnalysis.indicators.escape.resistance.toLocaleString()}원 → 현재 +{stock.advancedAnalysis.indicators.escape.priceBreakout}% | 거래량 {stock.advancedAnalysis.indicators.escape.volumeRatio}x | 종가강도 {stock.advancedAnalysis.indicators.escape.closingStrength}%
                    </span>
                    {/* 툴팁 - 중앙 정렬 */}
                    <div className="absolute left-1/2 transform -translate-x-1/2 top-full mt-1 w-72 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-xl">
                      <div className="font-bold mb-1">🚀 탈출 속도 [30일 분석]</div>
                      <div className="space-y-1">
                        <div className="text-yellow-300">✅ 패턴 감지됨 - 강한 돌파!</div>
                        <div className="border-t border-gray-700 my-1"></div>
                        <div>📊 분석 기간: 최근 30일</div>
                        <div>📈 저항선: 최근 25일 중 최고가</div>
                        <div className="border-t border-gray-700 my-1"></div>
                        <div className="font-bold text-green-300">📌 돌파 현황:</div>
                        <div>• 저항선: {stock.advancedAnalysis.indicators.escape.resistance.toLocaleString()}원</div>
                        <div>• 현재가: {stock.advancedAnalysis.indicators.escape.currentPrice.toLocaleString()}원</div>
                        <div>• 돌파율: +{stock.advancedAnalysis.indicators.escape.priceBreakout}%</div>
                        <div>• 거래량: 평균 대비 {stock.advancedAnalysis.indicators.escape.volumeRatio}배</div>
                        <div className="border-t border-gray-700 my-1"></div>
                        <div className="font-bold text-cyan-300">🎯 마감 강도:</div>
                        <div>• 종가 위치: {stock.advancedAnalysis.indicators.escape.closingStrength}%</div>
                        <div>  (70% 이상 = 강한 마감 ✅)</div>
                        <div>• 고가 대비 하락: -{stock.advancedAnalysis.indicators.escape.highDecline}%</div>
                        <div>  (10% 미만 = 안정 ✅)</div>
                        <div className="border-t border-gray-700 my-1"></div>
                        <div className="font-bold text-blue-300">💡 의미:</div>
                        <div>저항선 돌파 + 거래량 폭발 + 강한 마감</div>
                        <div>상승 모멘텀 견고 - 추격 매수 타이밍</div>
                      </div>
                      {/* 화살표 - 중앙 */}
                      <div className="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                        <div className="border-4 border-transparent border-t-gray-900"></div>
                      </div>
                    </div>
                  </div>
                )}
                {!stock.advancedAnalysis.indicators.escape.detected && stock.advancedAnalysis.indicators.escape.warning && (
                  <div className="relative group inline-block">
                    <span className="cursor-help border-b border-dotted border-red-400 text-orange-600">
                      {stock.advancedAnalysis.indicators.escape.signal}
                    </span>
                    {/* 경고 툴팁 */}
                    <div className="absolute left-1/2 transform -translate-x-1/2 top-full mt-1 w-72 px-3 py-2 bg-red-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-xl">
                      <div className="font-bold mb-1">⚠️ 탈출 실패 경고</div>
                      <div className="space-y-1">
                        <div className="text-yellow-300">{stock.advancedAnalysis.indicators.escape.warning}</div>
                        <div className="border-t border-red-700 my-1"></div>
                        <div>• 종가 강도: {stock.advancedAnalysis.indicators.escape.closingStrength}%</div>
                        <div>• 고가 대비 낙폭: -{stock.advancedAnalysis.indicators.escape.highDecline}%</div>
                        <div className="border-t border-red-700 my-1"></div>
                        <div className="font-bold text-orange-300">💡 해석:</div>
                        <div>장중 급등 후 되돌림 발생</div>
                        <div>익일 추가 하락 가능성 - 진입 보류</div>
                      </div>
                      <div className="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                        <div className="border-4 border-transparent border-t-red-900"></div>
                      </div>
                    </div>
                  </div>
                )}
                {stock.advancedAnalysis.indicators.drain.detected && (
                  <div className="relative group inline-block">
                    <span className="cursor-help border-b border-dotted border-gray-400">
                      💧 유동성고갈: 최근10일 vs 이전20일 | 거래량 {stock.advancedAnalysis.indicators.drain.volumeDecline}% | 변동성 {stock.advancedAnalysis.indicators.drain.volatilityDecline}%
                    </span>
                    {/* 툴팁 - 오른쪽 정렬 */}
                    <div className="absolute right-0 top-full mt-1 w-72 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-xl">
                      <div className="font-bold mb-1">💧 유동성 고갈 [30일 분석]</div>
                      <div className="space-y-1">
                        <div className="text-yellow-300">✅ 패턴 감지됨</div>
                        <div className="border-t border-gray-700 my-1"></div>
                        <div>📊 분석 기간: 최근 30일</div>
                        <div>📈 비교 방식: 최근 10일 vs 이전 20일</div>
                        <div className="border-t border-gray-700 my-1"></div>
                        <div className="font-bold text-green-300">📌 측정 지표:</div>
                        <div>• 거래량 감소: {stock.advancedAnalysis.indicators.drain.volumeDecline}%</div>
                        <div>  (최근 10일 평균 vs 이전 20일 평균)</div>
                        <div>• 변동성 감소: {stock.advancedAnalysis.indicators.drain.volatilityDecline}%</div>
                        <div>  (스프링 압축 상태)</div>
                        <div className="border-t border-gray-700 my-1"></div>
                        <div className="font-bold text-blue-300">💡 의미:</div>
                        <div>거래량 급감 + 변동성 축소</div>
                        <div>곧 큰 움직임 전조 (상승/하락 불확실)</div>
                      </div>
                      {/* 화살표 - 오른쪽 */}
                      <div className="absolute top-full right-6 transform -mt-1">
                        <div className="border-4 border-transparent border-t-gray-900"></div>
                      </div>
                    </div>
                  </div>
                )}
                <div className="relative group inline-block">
                  <span className="cursor-help border-b border-dotted border-gray-400">
                    📊 비대칭비율 (최근20일): {stock.advancedAnalysis.indicators.asymmetric.ratio}배 (상승{stock.advancedAnalysis.indicators.asymmetric.upDays}일 vs 하락{stock.advancedAnalysis.indicators.asymmetric.downDays}일)
                  </span>
                  {/* 툴팁 - 중앙 정렬 (항상 표시되므로) */}
                  <div className="absolute left-1/2 transform -translate-x-1/2 top-full mt-1 w-72 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-xl">
                    <div className="font-bold mb-1">📊 비대칭 비율 [최근 20일 분석]</div>
                    <div className="space-y-1">
                      <div className="text-yellow-300">✅ 상승일 거래량이 {stock.advancedAnalysis.indicators.asymmetric.ratio}배 더 많음</div>
                      <div className="border-t border-gray-700 my-1"></div>
                      <div>📊 분석 기간: 최근 20일</div>
                      <div>📈 비교 대상: 상승일 총 거래량 vs 하락일 총 거래량</div>
                      <div className="border-t border-gray-700 my-1"></div>
                      <div className="font-bold text-green-300">📌 거래량 분포:</div>
                      <div>• 상승일: {stock.advancedAnalysis.indicators.asymmetric.upDays}일 ({(stock.advancedAnalysis.indicators.asymmetric.upVolume / 1000000).toFixed(1)}M주)</div>
                      <div>• 하락일: {stock.advancedAnalysis.indicators.asymmetric.downDays}일 ({(stock.advancedAnalysis.indicators.asymmetric.downVolume / 1000000).toFixed(1)}M주)</div>
                      <div>• 비율: {stock.advancedAnalysis.indicators.asymmetric.ratio}배</div>
                      <div className="border-t border-gray-700 my-1"></div>
                      <div className="font-bold text-blue-300">💡 해석:</div>
                      <div>• 비율 &gt; 1.5: 세력 매집 중 🔥</div>
                      <div>• 비율 &lt; 0.7: 세력 매도 중 ⚠️</div>
                      <div className="mt-1 text-green-300">→ {stock.advancedAnalysis.indicators.asymmetric.signal}</div>
                    </div>
                    {/* 화살표 - 중앙 */}
                    <div className="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                      <div className="border-4 border-transparent border-t-gray-900"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* 주요 지표 */}
            <div className="grid grid-cols-3 gap-2 text-sm">
              <div className="bg-blue-50 p-2 rounded relative group">
                <p className="text-gray-600 text-xs">거래량 비율 ⓘ</p>
                <p className="font-bold text-blue-700">{volumeRatio ? `${volumeRatio}x` : 'N/A'}</p>
                {/* 툴팁 - 왼쪽 정렬 */}
                <div className="absolute bottom-full left-0 mb-2 w-72 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-xl">
                  <div className="font-bold mb-1">📊 거래량 비율이란?</div>
                  <div className="space-y-1">
                    <div>"오늘 거래량 ÷ 20일 평균"</div>
                    <div className="text-yellow-300">• {volumeRatio}배 = 평소보다 {volumeRatio}배 많은 거래</div>
                    <div>• 5배+ : 🔥🔥🔥 초대량 (이벤트)</div>
                    <div>• 3-5배: 🔥🔥 대량 (세력)</div>
                    <div>• 2-3배: 🔥 급증 (관심)</div>
                    <div>• 1.5배-: 📈 정상</div>
                    <div className="text-red-300 mt-1">⚠️ 10배+ = 과열 위험</div>
                  </div>
                  <div className="absolute top-full left-6 transform -mt-1">
                    <div className="border-4 border-transparent border-t-gray-900"></div>
                  </div>
                </div>
              </div>
              <div className="bg-purple-50 p-2 rounded relative group">
                <p className="text-gray-600 text-xs">MFI ⓘ</p>
                <p className="font-bold text-purple-700">
                  {stock.volumeAnalysis.indicators.mfi?.toFixed(1) || 'N/A'}
                </p>
                {/* 툴팁 - 중앙 정렬 */}
                <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-72 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-xl">
                  <div className="font-bold mb-1">💰 MFI (자금흐름지수)</div>
                  <div className="space-y-1">
                    <div>"거래량 반영한 RSI"</div>
                    <div className="text-red-300">• 90+: 🔴 극과매수 (위험)</div>
                    <div className="text-orange-300">• 80-90: 🟠 과매수 (신중)</div>
                    <div className="text-yellow-300">• 70-80: 🟡 강세 (지속)</div>
                    <div className="text-green-300">• 50-70: 🟢 정상 (매수)</div>
                    <div className="text-blue-300">• 20-30: 🔵 과매도 (기회)</div>
                    <div className="text-indigo-300">• 20-: 💙 극과매도 (최대기회)</div>
                    <div className="text-yellow-300 mt-1">⚠️ 과매수 ≠ 매도 (강세 지속 가능)</div>
                  </div>
                  <div className="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                    <div className="border-4 border-transparent border-t-gray-900"></div>
                  </div>
                </div>
              </div>
              <div className="bg-green-50 p-2 rounded relative group">
                <p className="text-gray-600 text-xs">비대칭 ⓘ</p>
                <p className="font-bold text-green-700">
                  {stock.advancedAnalysis.indicators.asymmetric.ratio || 'N/A'}
                </p>
                {/* 툴팁 - 오른쪽 정렬 */}
                <div className="absolute bottom-full right-0 mb-2 w-64 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-xl">
                  <div className="font-bold mb-1">📊 비대칭 비율이란?</div>
                  <div className="space-y-1">
                    <div>"상승일 vs 하락일 거래량 비교"</div>
                    <div className="text-yellow-300">• {stock.advancedAnalysis.indicators.asymmetric.ratio}배 = 상승일 거래량이 {stock.advancedAnalysis.indicators.asymmetric.ratio}배 더 많음</div>
                    <div>• 상승: {stock.advancedAnalysis.indicators.asymmetric.upDays}일 ({(stock.advancedAnalysis.indicators.asymmetric.upVolume / 1000000).toFixed(1)}M)</div>
                    <div>• 하락: {stock.advancedAnalysis.indicators.asymmetric.downDays}일 ({(stock.advancedAnalysis.indicators.asymmetric.downVolume / 1000000).toFixed(1)}M)</div>
                    <div className="text-green-300 mt-1">→ {stock.advancedAnalysis.indicators.asymmetric.signal}</div>
                  </div>
                  <div className="absolute top-full right-6 transform -mt-1">
                    <div className="border-4 border-transparent border-t-gray-900"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // 로딩 화면
    function LoadingScreen() {
      return (
        <div className="text-center py-20">
          <div className="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-600 mb-4"></div>
          <h3 className="text-2xl font-bold text-gray-800 mb-2">AI가 종목을 분석하고 있습니다...</h3>
          <p className="text-gray-600">전체 종목 스크리닝 중 (수 분 소요)</p>
        </div>
      );
    }

    // 빈 상태 화면
    function EmptyState({ category }) {
      const categoryNames = {
        'all': '종합 TOP',
        'whale': '고래 감지',
        'accumulation': '조용한 매집',
        'escape': '탈출 속도',
        'drain': '유동성 고갈',
        'volume-surge': '거래량 폭발'
      };

      return (
        <div className="text-center py-20">
          <div className="text-6xl mb-4">📭</div>
          <h3 className="text-2xl font-bold text-gray-800 mb-2">
            조회된 종목이 없습니다
          </h3>
          <p className="text-gray-600">
            현재 <span className="font-semibold text-indigo-600">{categoryNames[category] || '선택된'}</span> 조건에 해당하는 종목이 없습니다.
          </p>
          <p className="text-gray-500 text-sm mt-2">
            다른 카테고리를 선택하거나 잠시 후 다시 시도해주세요.
          </p>
        </div>
      );
    }

    // 종목 상세 모달
    function StockDetailModal({ stock, onClose }) {
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onClick={onClose}>
          <div className="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl" onClick={(e) => e.stopPropagation()}>
            {/* 헤더 */}
            <div className="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-t-2xl">
              <div className="flex justify-between items-start">
                <div>
                  <h2 className="text-3xl font-bold">{stock.stockName}</h2>
                  <p className="text-indigo-100 mt-1">{stock.stockCode}</p>
                </div>
                <button
                  onClick={onClose}
                  className="text-white hover:text-gray-200 text-3xl leading-none"
                >
                  ×
                </button>
              </div>

              <div className="mt-4 flex items-baseline gap-4">
                <span className="text-4xl font-bold">{stock.currentPrice.toLocaleString()}원</span>
                <span className={`text-xl font-semibold ${stock.changeRate >= 0 ? 'text-red-300' : 'text-blue-300'}`}>
                  {stock.changeRate >= 0 ? '▲' : '▼'} {Math.abs(stock.changeRate).toFixed(2)}%
                </span>
              </div>
            </div>

            {/* 콘텐츠 */}
            <div className="p-6 space-y-6">
              {/* 종합 평가 */}
              <div className="bg-gradient-to-br from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl p-6">
                <h3 className="text-xl font-bold mb-3">🎯 종합 평가</h3>
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-3xl font-bold text-indigo-600">{stock.totalScore}점</p>
                    <p className="text-gray-600 mt-1">{stock.recommendation.text}</p>
                  </div>
                  <div className={`grade-${stock.recommendation.grade} w-24 h-24 rounded-full flex items-center justify-center`}>
                    <span className="text-white text-5xl font-bold">{stock.recommendation.grade}</span>
                  </div>
                </div>
              </div>

              {/* 창의적 지표 */}
              <div className="bg-white border-2 border-gray-200 rounded-xl p-6">
                <h3 className="text-xl font-bold mb-4">🔍 창의적 지표 분석</h3>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {/* 고래 감지 */}
                  <IndicatorBox
                    title="🐋 고래 감지"
                    detected={stock.advancedAnalysis.indicators.whale.length > 0}
                    signal={stock.advancedAnalysis.indicators.whale.length > 0 ? `${stock.advancedAnalysis.indicators.whale.length}건 감지` : '없음'}
                    detail={stock.advancedAnalysis.indicators.whale.length > 0 ?
                      stock.advancedAnalysis.indicators.whale.map(w =>
                        `${w.date.slice(4,6)}/${w.date.slice(6,8)}: 거래량 ${w.volumeRatio}배, 가격 +${w.priceChange}%, 강도 ${w.intensity.toFixed(1)}`
                      ).join(' | ') : '거래량 급증 + 가격 상승 조합 미발견'}
                  />

                  {/* 조용한 매집 */}
                  <IndicatorBox
                    title="🤫 조용한 매집"
                    detected={stock.advancedAnalysis.indicators.accumulation.detected}
                    signal={stock.advancedAnalysis.indicators.accumulation.signal}
                    detail={`거래량↑${stock.advancedAnalysis.indicators.accumulation.volumeGrowth}% / 변동성↓${stock.advancedAnalysis.indicators.accumulation.priceVolatility}% / 평균가 ${stock.advancedAnalysis.indicators.accumulation.avgPrice.toLocaleString()}원 / 점수 ${stock.advancedAnalysis.indicators.accumulation.score}`}
                  />

                  {/* 탈출 속도 */}
                  <IndicatorBox
                    title="🚀 탈출 속도"
                    detected={stock.advancedAnalysis.indicators.escape.detected}
                    signal={stock.advancedAnalysis.indicators.escape.signal}
                    detail={stock.advancedAnalysis.indicators.escape.detected ?
                      `저항선 ${stock.advancedAnalysis.indicators.escape.resistance.toLocaleString()}원 → 현재 ${stock.advancedAnalysis.indicators.escape.currentPrice.toLocaleString()}원 (+${stock.advancedAnalysis.indicators.escape.priceBreakout}%) / 거래량 ${stock.advancedAnalysis.indicators.escape.volumeRatio}배 / 모멘텀 ${stock.advancedAnalysis.indicators.escape.momentum} / 점수 ${stock.advancedAnalysis.indicators.escape.score.toFixed(1)}`
                      : `저항선 돌파 실패 / 점수 ${stock.advancedAnalysis.indicators.escape.score}`}
                  />

                  {/* 유동성 고갈 */}
                  <IndicatorBox
                    title="💧 유동성 고갈"
                    detected={stock.advancedAnalysis.indicators.drain.detected}
                    signal={stock.advancedAnalysis.indicators.drain.signal}
                    detail={`거래량↓${stock.advancedAnalysis.indicators.drain.volumeDecline}% / 변동성↓${stock.advancedAnalysis.indicators.drain.volatilityDecline}% / 최근평균 ${(stock.advancedAnalysis.indicators.drain.avgVolumeRecent / 1000).toFixed(0)}K / 점수 ${stock.advancedAnalysis.indicators.drain.score}`}
                  />

                  {/* 비대칭 거래량 */}
                  <IndicatorBox
                    title="📊 비대칭 거래량"
                    detected={stock.advancedAnalysis.indicators.asymmetric.ratio >= 1.5}
                    signal={stock.advancedAnalysis.indicators.asymmetric.signal}
                    detail={`비율 ${stock.advancedAnalysis.indicators.asymmetric.ratio} | 상승 ${stock.advancedAnalysis.indicators.asymmetric.upDays}일 (${(stock.advancedAnalysis.indicators.asymmetric.upVolume / 1000000).toFixed(1)}M) vs 하락 ${stock.advancedAnalysis.indicators.asymmetric.downDays}일 (${(stock.advancedAnalysis.indicators.asymmetric.downVolume / 1000000).toFixed(1)}M) | 상승일 거래량이 ${stock.advancedAnalysis.indicators.asymmetric.ratio}배 더 많음 → ${stock.advancedAnalysis.indicators.asymmetric.ratio >= 3 ? '세력 강력 매집 🔥🔥' : stock.advancedAnalysis.indicators.asymmetric.ratio >= 1.5 ? '세력 매집 중 🔥' : stock.advancedAnalysis.indicators.asymmetric.ratio <= 0.7 ? '세력 매도 중 ⚠️' : '중립 ⚖️'} / 점수 ${stock.advancedAnalysis.indicators.asymmetric.score.toFixed(1)}`}
                  />
                </div>

                <div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                  <h4 className="font-bold text-blue-900 mb-2">💡 비대칭 거래량 해석</h4>
                  <div className="text-sm text-blue-800 space-y-1">
                    <div>• 비율 &gt; 3.0: 세력이 강력하게 매집 중 (상승일 거래량이 3배 이상) 🔥🔥🔥</div>
                    <div>• 비율 1.5~3.0: 세력이 매집 중 (상승일 거래량 우위) 🔥</div>
                    <div>• 비율 0.7~1.5: 중립 (균형) ⚖️</div>
                    <div>• 비율 &lt; 0.7: 세력이 매도 중 (하락일 거래량 더 많음) ⚠️</div>
                  </div>
                </div>
              </div>

              {/* 거래량 지표 */}
              <div className="bg-white border-2 border-gray-200 rounded-xl p-6">
                <h3 className="text-xl font-bold mb-4">📊 거래량 지표</h3>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                  <StatBox
                    label="MFI (자금흐름지수)"
                    value={stock.volumeAnalysis.indicators.mfi?.toFixed(1)}
                    desc={
                      stock.volumeAnalysis.indicators.mfi >= 70 ? '과매수' :
                      stock.volumeAnalysis.indicators.mfi <= 30 ? '과매도' : '중립'
                    }
                  />
                  <StatBox
                    label="OBV (거래량 추세)"
                    value={(stock.volumeAnalysis.indicators.obv / 1000000).toFixed(1) + 'M'}
                    desc={stock.volumeAnalysis.signals.obvTrend}
                  />
                  <StatBox
                    label="VWAP (평균가)"
                    value={stock.volumeAnalysis.indicators.vwap?.toLocaleString()}
                    desc={stock.volumeAnalysis.signals.priceVsVWAP}
                  />
                </div>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                  <StatBox
                    label="거래량 비율"
                    value={stock.volumeAnalysis.current.volumeMA20 ?
                      (stock.volume / stock.volumeAnalysis.current.volumeMA20).toFixed(1) + 'x' : 'N/A'}
                    desc="vs 20일 평균"
                  />
                  <StatBox
                    label="비대칭 비율 (상승일/하락일)"
                    value={stock.advancedAnalysis.indicators.asymmetric.ratio}
                    desc={`${stock.advancedAnalysis.indicators.asymmetric.signal} | 상승 ${stock.advancedAnalysis.indicators.asymmetric.upDays}일(${(stock.advancedAnalysis.indicators.asymmetric.upVolume / 1000000).toFixed(0)}M) vs 하락 ${stock.advancedAnalysis.indicators.asymmetric.downDays}일(${(stock.advancedAnalysis.indicators.asymmetric.downVolume / 1000000).toFixed(0)}M)`}
                  />
                  <StatBox
                    label="시가총액"
                    value={(stock.marketCap / 100000000).toFixed(0) + '억'}
                    desc="원"
                  />
                </div>
              </div>

              {/* 신호 요약 */}
              <div className="bg-indigo-50 border-2 border-indigo-200 rounded-xl p-6">
                <h3 className="text-xl font-bold mb-4 text-indigo-900">📢 감지된 신호</h3>
                <div className="flex flex-wrap gap-2">
                  {stock.advancedAnalysis.signals.map((signal, i) => (
                    <span key={i} className="bg-white px-4 py-2 rounded-lg border-2 border-indigo-300 font-semibold text-indigo-700">
                      {signal}
                    </span>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // 지표 박스
    function IndicatorBox({ title, detected, signal, detail }) {
      return (
        <div className={`p-4 rounded-lg border-2 ${detected ? 'bg-green-50 border-green-300' : 'bg-gray-50 border-gray-200'}`}>
          <h4 className="font-bold mb-2">{title}</h4>
          <p className={`font-semibold mb-1 ${detected ? 'text-green-700' : 'text-gray-500'}`}>
            {signal}
          </p>
          {detail && <p className="text-xs text-gray-600 leading-relaxed whitespace-pre-wrap break-words">{detail}</p>}
        </div>
      );
    }

    // 통계 박스
    function StatBox({ label, value, desc }) {
      return (
        <div className="bg-gray-50 p-3 rounded-lg">
          <p className="text-xs text-gray-600 mb-1">{label}</p>
          <p className="text-lg font-bold text-gray-900">{value || 'N/A'}</p>
          {desc && <p className="text-xs text-gray-500 mt-1">{desc}</p>}
        </div>
      );
    }

    // 성과 검증 컴포넌트
    function PerformanceVerification({ apiBaseUrl }) {
      const [backtestData, setBacktestData] = useState(null);
      const [trackerData, setTrackerData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [activeView, setActiveView] = useState('backtest'); // backtest or realtime

      useEffect(() => {
        fetchPerformanceData();
      }, []);

      const fetchPerformanceData = async () => {
        setLoading(true);
        setError(null);

        try {
          // 백테스팅 데이터
          const backtestRes = await fetch(`${apiBaseUrl}/backtest`);
          const backtestResult = await backtestRes.json();

          if (backtestResult.success) {
            setBacktestData(backtestResult.data);
          }

          // 실시간 추적 데이터
          const trackerRes = await fetch(`${apiBaseUrl}/tracker?action=performance`);
          const trackerResult = await trackerRes.json();

          if (trackerResult.success) {
            setTrackerData(trackerResult.data);
          }
        } catch (err) {
          setError('성과 데이터 로드 실패: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      if (loading) {
        return (
          <div className="text-center py-20">
            <div className="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-600 mb-4"></div>
            <h3 className="text-2xl font-bold text-gray-800 mb-2">성과 데이터 분석 중...</h3>
            <p className="text-gray-600">과거 추천 종목의 수익률을 계산하고 있습니다</p>
          </div>
        );
      }

      if (error) {
        return (
          <div className="bg-red-100 border-l-4 border-red-500 text-red-700 px-4 py-3 rounded">
            {error}
          </div>
        );
      }

      const data = activeView === 'backtest' ? backtestData : trackerData;
      const stats = data?.statistics?.overall;

      if (!stats) {
        return (
          <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 px-4 py-3 rounded">
            충분한 성과 데이터가 없습니다. 시스템이 종목을 추천하고 시간이 지나야 성과를 확인할 수 있습니다.
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {/* 뷰 선택 */}
          <div className="bg-white rounded-xl shadow-lg p-4">
            <div className="flex gap-4 justify-center">
              <button
                onClick={() => setActiveView('backtest')}
                className={`px-6 py-3 rounded-lg font-semibold transition-all ${
                  activeView === 'backtest'
                    ? 'bg-indigo-600 text-white shadow-lg'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                📊 과거 백테스팅
              </button>
              <button
                onClick={() => setActiveView('realtime')}
                className={`px-6 py-3 rounded-lg font-semibold transition-all ${
                  activeView === 'realtime'
                    ? 'bg-indigo-600 text-white shadow-lg'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                ⏱️ 실시간 추적
              </button>
            </div>
          </div>

          {/* 전체 요약 카드 */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <SummaryCard
              title="전체 승률"
              value={`${stats.winRate}%`}
              subtext={`${stats.winCount}/${stats.totalCount} 종목 상승`}
              color="bg-gradient-to-br from-green-500 to-green-600"
              icon="✅"
            />
            <SummaryCard
              title="평균 수익률"
              value={`${stats.avgReturn > 0 ? '+' : ''}${stats.avgReturn}%`}
              subtext={`${data.parameters?.holdingDays || 7}일 보유 기준`}
              color="bg-gradient-to-br from-blue-500 to-blue-600"
              icon="📈"
            />
            <SummaryCard
              title="최고 수익"
              value={`+${stats.maxReturn}%`}
              subtext={`손실 ${stats.minReturn}%`}
              color="bg-gradient-to-br from-purple-500 to-purple-600"
              icon="🔥"
            />
            <SummaryCard
              title="분석 샘플"
              value={`${stats.totalCount}개`}
              subtext={`${data.parameters?.lookbackDays || 30}일 기간`}
              color="bg-gradient-to-br from-orange-500 to-orange-600"
              icon="📊"
            />
          </div>

          {/* Phase 3: 고급 지표 */}
          {data.statistics?.advanced && (
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-2xl font-bold mb-6 flex items-center gap-2">
                🎯 고급 성과 지표 (Phase 3)
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <AdvancedMetricBox
                  label="샤프 비율"
                  value={data.statistics.advanced.sharpeRatio}
                  desc="위험 대비 수익 (>1 양호)"
                  good={data.statistics.advanced.sharpeRatio > 1}
                />
                <AdvancedMetricBox
                  label="MDD (최대 낙폭)"
                  value={`${data.statistics.advanced.maxDrawdown}%`}
                  desc="최대 손실 폭 (<10% 안정)"
                  good={data.statistics.advanced.maxDrawdown < 10}
                />
                <AdvancedMetricBox
                  label="Profit Factor"
                  value={data.statistics.advanced.profitFactor}
                  desc="수익/손실 비율 (>1.5 우수)"
                  good={data.statistics.advanced.profitFactor > 1.5}
                />
                <AdvancedMetricBox
                  label="KOSPI 초과수익"
                  value={`${data.statistics.advanced.excessReturn > 0 ? '+' : ''}${data.statistics.advanced.excessReturn}%`}
                  desc="시장 대비 초과 성과"
                  good={data.statistics.advanced.excessReturn > 0}
                />
              </div>
              <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                <h4 className="font-bold text-blue-900 mb-2">💡 종합 해석</h4>
                <div className="space-y-1">
                  {data.statistics.advanced.interpretation.map((interp, i) => (
                    <div key={i} className="text-sm text-blue-800">{interp}</div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* 등급별 성과 */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h3 className="text-2xl font-bold mb-6">📊 등급별 성과</h3>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-100">
                  <tr>
                    <th className="px-4 py-3 text-left">등급</th>
                    <th className="px-4 py-3 text-left">샘플 수</th>
                    <th className="px-4 py-3 text-left">승률</th>
                    <th className="px-4 py-3 text-left">평균 수익률</th>
                    <th className="px-4 py-3 text-left">최고 수익</th>
                  </tr>
                </thead>
                <tbody>
                  {Object.entries(data.statistics?.byGrade || {}).map(([grade, gstats]) => (
                    <tr key={grade} className="border-b hover:bg-gray-50">
                      <td className="px-4 py-3">
                        <span className={`inline-block px-3 py-1 rounded-full text-white font-bold grade-${grade}`}>
                          {grade}
                        </span>
                      </td>
                      <td className="px-4 py-3">{gstats.count}개</td>
                      <td className="px-4 py-3">
                        <span className={gstats.winRate >= 70 ? 'text-green-600 font-bold' : gstats.winRate >= 50 ? 'text-blue-600' : 'text-gray-600'}>
                          {gstats.winRate}%
                        </span>
                      </td>
                      <td className="px-4 py-3">
                        <span className={gstats.avgReturn > 0 ? 'text-red-600 font-bold' : 'text-blue-600'}>
                          {gstats.avgReturn > 0 ? '+' : ''}{gstats.avgReturn}%
                        </span>
                      </td>
                      <td className="px-4 py-3 text-green-600 font-semibold">+{gstats.maxReturn}%</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* 카테고리별 성과 */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h3 className="text-2xl font-bold mb-6">🎯 카테고리별 성과</h3>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-100">
                  <tr>
                    <th className="px-4 py-3 text-left">카테고리</th>
                    <th className="px-4 py-3 text-left">샘플 수</th>
                    <th className="px-4 py-3 text-left">승률</th>
                    <th className="px-4 py-3 text-left">평균 수익률</th>
                    <th className="px-4 py-3 text-left">최고 수익</th>
                  </tr>
                </thead>
                <tbody>
                  {Object.entries(data.statistics?.byCategory || {}).map(([key, cstats]) => (
                    <tr key={key} className="border-b hover:bg-gray-50">
                      <td className="px-4 py-3 font-semibold">{cstats.label}</td>
                      <td className="px-4 py-3">{cstats.count}개</td>
                      <td className="px-4 py-3">
                        <span className={cstats.winRate >= 70 ? 'text-green-600 font-bold' : cstats.winRate >= 50 ? 'text-blue-600' : 'text-gray-600'}>
                          {cstats.winRate}%
                        </span>
                      </td>
                      <td className="px-4 py-3">
                        <span className={cstats.avgReturn > 0 ? 'text-red-600 font-bold' : 'text-blue-600'}>
                          {cstats.avgReturn > 0 ? '+' : ''}{cstats.avgReturn}%
                        </span>
                      </td>
                      <td className="px-4 py-3 text-green-600 font-semibold">+{cstats.maxReturn}%</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* Phase 3: 포트폴리오 시뮬레이션 */}
          {data.portfolio && (
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-2xl font-bold mb-6 flex items-center gap-2">
                💼 포트폴리오 시뮬레이션 (5종목 균등 분산)
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div className="bg-green-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">포트폴리오 평균 수익률</p>
                  <p className="text-2xl font-bold text-green-700">
                    {data.portfolio.summary.avgReturn > 0 ? '+' : ''}{data.portfolio.summary.avgReturn}%
                  </p>
                </div>
                <div className="bg-blue-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">총 누적 수익</p>
                  <p className="text-2xl font-bold text-blue-700">
                    {data.portfolio.summary.totalProfit.toLocaleString()}원
                  </p>
                </div>
                <div className="bg-purple-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-600">포트폴리오 수</p>
                  <p className="text-2xl font-bold text-purple-700">
                    {data.portfolio.summary.portfolioCount}개
                  </p>
                </div>
              </div>

              {/* 최고/최저 포트폴리오 */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="bg-green-50 border-2 border-green-300 rounded-lg p-4">
                  <h4 className="font-bold text-green-900 mb-2">🏆 최고 성과 포트폴리오</h4>
                  <p className="text-sm text-gray-600 mb-2">날짜: {data.portfolio.summary.bestPortfolio?.date}</p>
                  <p className="text-2xl font-bold text-green-700 mb-2">
                    +{data.portfolio.summary.bestPortfolio?.portfolioReturn}%
                  </p>
                  <div className="text-xs text-gray-700">
                    {data.portfolio.summary.bestPortfolio?.stocks.map((s, i) => (
                      <div key={i}>{s.name} ({s.return > 0 ? '+' : ''}{s.return}%)</div>
                    ))}
                  </div>
                </div>

                <div className="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                  <h4 className="font-bold text-red-900 mb-2">⚠️ 최저 성과 포트폴리오</h4>
                  <p className="text-sm text-gray-600 mb-2">날짜: {data.portfolio.summary.worstPortfolio?.date}</p>
                  <p className="text-2xl font-bold text-red-700 mb-2">
                    {data.portfolio.summary.worstPortfolio?.portfolioReturn}%
                  </p>
                  <div className="text-xs text-gray-700">
                    {data.portfolio.summary.worstPortfolio?.stocks.map((s, i) => (
                      <div key={i}>{s.name} ({s.return > 0 ? '+' : ''}{s.return}%)</div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Phase 3: 시장 상황별 분석 */}
          {data.byMarket && (
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-2xl font-bold mb-6">📊 시장 상황별 성과</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {Object.entries(data.byMarket).map(([key, mstats]) => (
                  <div key={key} className="bg-gray-50 border-2 border-gray-200 rounded-lg p-4">
                    <h4 className="font-bold text-gray-900 mb-2">{mstats.label}</h4>
                    <div className="space-y-1 text-sm">
                      <div>샘플: {mstats.count}개</div>
                      <div className={mstats.winRate >= 60 ? 'text-green-600 font-bold' : 'text-gray-700'}>
                        승률: {mstats.winRate}%
                      </div>
                      <div className={mstats.avgReturn > 0 ? 'text-red-600 font-bold' : 'text-blue-600'}>
                        평균: {mstats.avgReturn > 0 ? '+' : ''}{mstats.avgReturn}%
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* 데이터 생성 시간 */}
          <div className="text-center text-sm text-gray-500">
            데이터 생성: {new Date(data.generatedAt).toLocaleString('ko-KR')}
          </div>
        </div>
      );
    }

    // 요약 카드
    function SummaryCard({ title, value, subtext, color, icon }) {
      return (
        <div className={`${color} rounded-xl shadow-lg p-6 text-white`}>
          <div className="flex items-center justify-between mb-2">
            <h3 className="text-sm font-semibold opacity-90">{title}</h3>
            <span className="text-2xl">{icon}</span>
          </div>
          <p className="text-3xl font-bold mb-1">{value}</p>
          <p className="text-sm opacity-80">{subtext}</p>
        </div>
      );
    }

    // 고급 지표 박스
    function AdvancedMetricBox({ label, value, desc, good }) {
      return (
        <div className={`p-4 rounded-lg border-2 ${good ? 'bg-green-50 border-green-300' : 'bg-gray-50 border-gray-200'}`}>
          <p className="text-xs text-gray-600 mb-1">{label}</p>
          <p className={`text-2xl font-bold mb-1 ${good ? 'text-green-700' : 'text-gray-700'}`}>{value}</p>
          <p className="text-xs text-gray-500">{desc}</p>
        </div>
      );
    }

    // 패턴 분석 컴포넌트
    function PatternAnalysis({ apiBaseUrl }) {
      const [patterns, setPatterns] = useState([]);
      const [selectedPattern, setSelectedPattern] = useState(null);
      const [matchedStocks, setMatchedStocks] = useState([]);
      const [loading, setLoading] = useState(true);
      const [analyzing, setAnalyzing] = useState(false);
      const [stocksLoading, setStocksLoading] = useState(false);
      const [error, setError] = useState(null);
      const [analysisInfo, setAnalysisInfo] = useState(null); // 분석 메타데이터

      useEffect(() => {
        fetchPatterns();
      }, []);

      // 패턴 목록 조회 (로컬스토리지 우선)
      const fetchPatterns = async () => {
        setLoading(true);
        setError(null);

        try {
          // 1. 먼저 로컬스토리지에서 확인
          const cachedData = localStorage.getItem('investar_patterns_cache');
          if (cachedData) {
            const parsed = JSON.parse(cachedData);
            setPatterns(parsed.patterns || []);
            setAnalysisInfo({
              generatedAt: parsed.generatedAt,
              parameters: parsed.parameters
            });
            console.log('✅ 로컬스토리지에서 패턴 로드 완료');
            setLoading(false);
            return;
          }

          // 2. 로컬스토리지에 없으면 API 호출 (캐시 미스)
          const response = await fetch(`${apiBaseUrl}/patterns/list`);
          const result = await response.json();

          if (result.success) {
            setPatterns(result.patterns || []);
            // 분석 정보 저장 (생성 시간, 파라미터 등)
            setAnalysisInfo({
              generatedAt: result.generatedAt,
              parameters: result.parameters,
              cacheInfo: result.cacheInfo
            });
          } else {
            setError(result.message || '패턴을 불러올 수 없습니다.');
          }
        } catch (err) {
          setError('서버와 연결할 수 없습니다: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      // 패턴 분석 실행 (관리자 기능)
      const runPatternAnalysis = async () => {
        if (!confirm('패턴 분석을 실행하시겠습니까? (약 3~5분 소요)')) return;

        setAnalyzing(true);
        setError(null);

        try {
          const response = await fetch(`${apiBaseUrl}/patterns/analyze`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const result = await response.json();

          if (result.success) {
            // 패턴 데이터를 로컬스토리지에 저장 (Vercel Serverless 메모리 캐시 대신)
            const cacheData = {
              generatedAt: result.generatedAt,
              parameters: result.parameters,
              patterns: result.patterns
            };
            localStorage.setItem('investar_patterns_cache', JSON.stringify(cacheData));
            console.log('✅ 패턴 데이터 로컬스토리지 저장 완료');

            // alert 대신 패턴 목록 바로 갱신하고 UI에 표시
            setPatterns(result.patterns || []);
            setAnalysisInfo({
              generatedAt: result.generatedAt,
              parameters: result.parameters
            });
            setLoading(false);
            // 성공 메시지는 화면에 표시
            setError(null);
          } else {
            setError(result.error || '패턴 분석 실패');
          }
        } catch (err) {
          setError('패턴 분석 중 오류 발생: ' + err.message);
        } finally {
          setAnalyzing(false);
        }
      };

      // 패턴 선택 및 매칭 종목 조회
      const selectPattern = async (pattern) => {
        setSelectedPattern(pattern);
        setStocksLoading(true);
        setError(null);

        try {
          const response = await fetch(`${apiBaseUrl}/patterns/matched-stocks?pattern=${pattern.key}`);

          // 404 또는 오류 응답 처리
          if (!response.ok) {
            console.warn(`⚠️ matched-stocks API 응답 오류: ${response.status}`);
            // Fallback: 빈 배열 반환 (패턴 분석은 완료됐지만 실시간 매칭 불가)
            setMatchedStocks([]);
            setError('현재 이 패턴과 매칭되는 종목이 없거나, 서버 캐시가 만료되었습니다. 잠시 후 다시 시도해주세요.');
            setStocksLoading(false);
            return;
          }

          const result = await response.json();

          if (result.success) {
            // 완전 매칭 + 부분 매칭 종목을 합쳐서 저장
            const allMatches = [
              ...(result.stocks || []).map(s => ({ ...s, matchType: 'complete' })),
              ...(result.partialStocks || []).map(s => ({ ...s, matchType: 'partial' }))
            ];
            setMatchedStocks(allMatches);
          } else {
            setError(result.error || '매칭 종목을 불러올 수 없습니다.');
            setMatchedStocks([]);
          }
        } catch (err) {
          setError('매칭 종목 조회 실패: ' + err.message);
          setMatchedStocks([]);
        } finally {
          setStocksLoading(false);
        }
      };

      if (loading) {
        return (
          <div className="text-center py-20">
            <div className="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-600 mb-4"></div>
            <h3 className="text-2xl font-bold text-gray-800 mb-2">패턴 데이터 로딩 중...</h3>
          </div>
        );
      }

      if (error && patterns.length === 0) {
        return (
          <div className="space-y-4">
            <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 px-4 py-3 rounded">
              <p className="font-bold">패턴이 아직 생성되지 않았습니다</p>
              <p className="text-sm mt-1">{error}</p>
              <p className="text-sm mt-2">아래 버튼을 클릭하여 패턴 분석을 실행하세요.</p>
            </div>
            <button
              onClick={runPatternAnalysis}
              disabled={analyzing}
              className="w-full px-6 py-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition disabled:opacity-50 font-semibold shadow-lg"
            >
              {analyzing ? '🔍 패턴 분석 중... (3~5분 소요)' : '🧠 패턴 분석 실행'}
            </button>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {/* 헤더 */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <div className="flex justify-between items-center">
              <div>
                <h2 className="text-2xl font-bold text-gray-900">🧠 급등 패턴 분석</h2>
                <p className="text-gray-600 mt-1">
                  과거 급등 종목의 공통 패턴을 학습하여 현재 매칭되는 종목을 찾습니다
                </p>
              </div>
              <button
                onClick={runPatternAnalysis}
                disabled={analyzing}
                className="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition disabled:opacity-50 font-semibold shadow-lg"
              >
                {analyzing ? '🔍 분석 중...' : '🔄 패턴 재분석'}
              </button>
            </div>
          </div>

          {/* 분석 진행 중 상태 */}
          {analyzing && (
            <div className="bg-blue-50 border-l-4 border-blue-500 p-6 rounded">
              <div className="flex items-center gap-4">
                <div className="inline-block animate-spin rounded-full h-8 w-8 border-t-4 border-b-4 border-blue-600"></div>
                <div>
                  <h4 className="font-bold text-blue-900 mb-1">패턴 분석 진행 중...</h4>
                  <p className="text-sm text-blue-700">
                    1️⃣ 거래량 증가율 상위 60개 종목 선별 중...<br/>
                    2️⃣ 급등 조건 필터링 중...<br/>
                    3️⃣ 패턴 추출 및 백테스팅 중...
                  </p>
                  <p className="text-xs text-blue-600 mt-2">⏱️ 약 3~5분 소요됩니다. 잠시만 기다려주세요.</p>
                </div>
              </div>
            </div>
          )}

          {/* 패턴 목록 */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h3 className="text-xl font-bold mb-4">📊 발견된 패턴 (승률 기준 상위 5개)</h3>

            {/* 분석 정보 표시 */}
            {patterns.length > 0 && analysisInfo && (
              <>
                <div className="bg-green-50 border-l-4 border-green-500 p-4 mb-3 rounded">
                  <p className="text-sm text-green-800">
                    ✅ <span className="font-bold">{patterns.length}개 패턴</span> 발견 완료!
                    아래 패턴을 클릭하면 현재 시장에서 해당 패턴과 매칭되는 종목을 볼 수 있습니다.
                  </p>
                </div>

                {/* 분석 기간 정보 */}
                {analysisInfo.parameters && (
                  <div className="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4 rounded">
                    <p className="text-sm font-semibold text-blue-900 mb-2">📅 분석 기간 정보</p>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs text-blue-800">
                      <div>
                        <span className="text-blue-600">분석 대상:</span> <span className="font-bold">{analysisInfo.parameters.totalQualified}개 종목</span>
                      </div>
                      <div>
                        <span className="text-blue-600">수익률 기준:</span> <span className="font-bold">{analysisInfo.parameters.lookbackDays}일간 +{analysisInfo.parameters.phase2MinReturn}% 이상</span>
                      </div>
                      <div>
                        <span className="text-blue-600">되돌림 필터:</span> <span className="font-bold">고가 대비 -{analysisInfo.parameters.phase3PullbackThreshold}% 미만</span>
                      </div>
                      {analysisInfo.generatedAt && (
                        <div>
                          <span className="text-blue-600">생성 시간:</span> <span className="font-bold">{new Date(analysisInfo.generatedAt).toLocaleString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </>
            )}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {patterns.map((pattern, index) => (
                <button
                  key={pattern.key}
                  onClick={() => selectPattern(pattern)}
                  className={`text-left p-4 rounded-lg border-2 transition-all ${
                    selectedPattern?.key === pattern.key
                      ? 'bg-purple-50 border-purple-500 shadow-lg'
                      : 'bg-gray-50 border-gray-200 hover:border-purple-300 hover:shadow-md'
                  }`}
                >
                  <div className="flex justify-between items-start mb-2">
                    <div className="flex items-center gap-2">
                      <span className="text-2xl font-bold text-purple-600">#{index + 1}</span>
                      <span className="text-lg font-bold text-gray-900">{pattern.name}</span>
                    </div>
                  </div>
                  <div className="space-y-1 text-sm">
                    <div className="flex justify-between">
                      <span className="text-gray-600">승률</span>
                      <span className={`font-bold ${pattern.backtest.winRate >= 70 ? 'text-green-600' : 'text-blue-600'}`}>
                        {pattern.backtest.winRate}%
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">평균 수익률</span>
                      <span className="font-bold text-red-600">+{pattern.backtest.avgReturn}%</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">출현 빈도</span>
                      <span className="font-bold text-gray-700">{pattern.frequency}%</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">샘플 수</span>
                      <span className="font-bold text-gray-700">{pattern.backtest.totalSamples}개</span>
                    </div>
                  </div>
                  <div className="mt-3 pt-3 border-t border-gray-200">
                    <div className="text-xs text-gray-500">
                      최고 수익: <span className="text-green-600 font-semibold">+{pattern.backtest.maxReturn}%</span>
                      {' / '}
                      최저 수익: <span className="text-red-600 font-semibold">{pattern.backtest.minReturn}%</span>
                    </div>
                  </div>
                  {/* 샘플 종목 표시 */}
                  {pattern.sampleStockNames && pattern.sampleStockNames.length > 0 && (
                    <div className="mt-3 pt-3 border-t border-gray-200">
                      <p className="text-xs text-gray-600 mb-1 font-semibold">📌 학습 샘플 종목:</p>
                      <div className="flex flex-wrap gap-1">
                        {pattern.sampleStockNames.map((name, i) => (
                          <span key={i} className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded" title={pattern.sampleStocks?.[i] || ''}>
                            {name} {pattern.sampleStocks?.[i] && `(${pattern.sampleStocks[i]})`}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </button>
              ))}
            </div>
          </div>

          {/* 선택된 패턴의 매칭 종목 */}
          {selectedPattern && (
            <div className="bg-white rounded-xl shadow-lg p-6">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-xl font-bold">
                  🎯 "{selectedPattern.name}" 패턴이 감지된 종목
                </h3>
                <button
                  onClick={() => selectPattern(selectedPattern)}
                  disabled={stocksLoading}
                  className="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition text-sm font-semibold"
                >
                  {stocksLoading ? '로딩 중...' : '🔄 새로고침'}
                </button>
              </div>

              {stocksLoading ? (
                <div className="text-center py-10">
                  <div className="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-purple-600 mb-3"></div>
                  <p className="text-gray-600">현재 80개 종목을 분석하여 패턴 매칭 중...</p>
                </div>
              ) : matchedStocks.length === 0 ? (
                <div className="text-center py-10 text-gray-500">
                  <div className="text-4xl mb-3">📭</div>
                  <p>현재 이 패턴과 매칭되는 종목이 없습니다.</p>
                  <p className="text-sm mt-2">시장 상황에 따라 매칭 종목이 달라집니다.</p>
                </div>
              ) : (
                <>
                  {/* 매칭 통계 */}
                  <div className="bg-purple-50 border-l-4 border-purple-500 p-4 mb-4 rounded">
                    <div className="flex items-center justify-between text-sm flex-wrap gap-2">
                      <div>
                        <span className="text-gray-700 font-semibold">총 {matchedStocks.length}개 종목 감지</span>
                        <span className="text-gray-600 ml-3">
                          (승률 {selectedPattern.backtest.winRate}% 기준, 평균 수익률 +{selectedPattern.backtest.avgReturn}%)
                        </span>
                      </div>
                      <div className="flex gap-2">
                        <span className="bg-green-600 text-white text-xs px-2 py-1 rounded-full font-semibold">
                          완전일치: {matchedStocks.filter(s => s.matchType === 'complete').length}개
                        </span>
                        <span className="bg-blue-600 text-white text-xs px-2 py-1 rounded-full font-semibold">
                          부분일치: {matchedStocks.filter(s => s.matchType === 'partial').length}개
                        </span>
                      </div>
                    </div>
                  </div>

                  {/* 완전 매칭 종목 */}
                  {matchedStocks.filter(s => s.matchType === 'complete').length > 0 && (
                    <div className="mb-6">
                      <h4 className="text-lg font-bold mb-3 flex items-center gap-2">
                        <span className="bg-green-600 text-white px-3 py-1 rounded-full text-sm">완전일치</span>
                        <span className="text-gray-700">패턴 100% 매칭</span>
                      </h4>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {matchedStocks.filter(s => s.matchType === 'complete').map((stock, index) => (
                          <div key={stock.stockCode} className="relative">
                            <div className="absolute top-2 right-2 z-10 bg-green-600 text-white text-xs px-2 py-1 rounded-full font-bold">
                              100%
                            </div>
                            <RecommendationCard
                              stock={stock}
                              rank={index + 1}
                              onClick={() => {}}
                            />
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* 부분 매칭 종목 */}
                  {matchedStocks.filter(s => s.matchType === 'partial').length > 0 && (
                    <div>
                      <h4 className="text-lg font-bold mb-3 flex items-center gap-2">
                        <span className="bg-blue-600 text-white px-3 py-1 rounded-full text-sm">부분일치</span>
                        <span className="text-gray-700">패턴 60% 이상 매칭</span>
                      </h4>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {matchedStocks.filter(s => s.matchType === 'partial').map((stock, index) => {
                          // 부분 매칭 정보 추출
                          const partialMatch = stock.patternMatch?.partialMatches?.find(p =>
                            p.key === selectedPattern.key || p.name === selectedPattern.name
                          );
                          const matchLevel = partialMatch?.matchLevel || '중';
                          const matchScore = partialMatch?.matchScore || 0;
                          const matchedConditions = partialMatch?.matchedConditions || [];
                          const missingConditions = partialMatch?.missingConditions || [];

                          return (
                            <div key={stock.stockCode} className="relative">
                              {/* 매칭도 뱃지 */}
                              <div className="absolute top-2 right-2 z-10 flex flex-col gap-1">
                                <div className={`text-white text-xs px-2 py-1 rounded-full font-bold ${
                                  matchLevel === '상' ? 'bg-orange-500' :
                                  matchLevel === '중' ? 'bg-blue-500' : 'bg-gray-500'
                                }`}>
                                  {matchLevel} ({Math.round(matchScore * 100)}%)
                                </div>
                              </div>
                              <div className="relative group">
                                <RecommendationCard
                                  stock={stock}
                                  rank={matchedStocks.filter(s => s.matchType === 'complete').length + index + 1}
                                  onClick={() => {}}
                                />
                                {/* 매칭 상세 정보 툴팁 */}
                                <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-72 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-xl">
                                  <div className="font-bold mb-1">🎯 패턴 매칭 상세</div>
                                  <div className="space-y-1">
                                    <div className="text-green-300">✅ 충족 조건 ({matchedConditions.length}개)</div>
                                    {matchedConditions.slice(0, 3).map((cond, i) => (
                                      <div key={i} className="text-xs pl-2">• {cond}</div>
                                    ))}
                                    {matchedConditions.length > 3 && (
                                      <div className="text-xs pl-2 text-gray-400">... 외 {matchedConditions.length - 3}개</div>
                                    )}
                                    <div className="border-t border-gray-700 my-1"></div>
                                    <div className="text-orange-300">❌ 미충족 조건 ({missingConditions.length}개)</div>
                                    {missingConditions.slice(0, 3).map((cond, i) => (
                                      <div key={i} className="text-xs pl-2">• {cond}</div>
                                    ))}
                                    {missingConditions.length > 3 && (
                                      <div className="text-xs pl-2 text-gray-400">... 외 {missingConditions.length - 3}개</div>
                                    )}
                                  </div>
                                  <div className="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                    <div className="border-4 border-transparent border-t-gray-900"></div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                </>
              )}
            </div>
          )}
        </div>
      );
    }

    // 렌더링
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
